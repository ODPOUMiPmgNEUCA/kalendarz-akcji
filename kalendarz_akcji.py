# -*- coding: utf-8 -*-
"""Kalendarz_akcji.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1bfU5lwdNa2GOPWmQ9-URaf30VnlBzQC0
"""

import openpyxl
import streamlit as st
import pandas as pd
import numpy as np
import altair as alt
import plotly.express as px
import plotly.graph_objects as go
from urllib.request import urlopen
import json
import io
import datetime
from streamlit_calendar import calendar
from datetime import datetime
import os

st.set_page_config(page_title='Kalendarz akcji', layout='wide')
st.title(" Kalendarz akcji")

#  PALETY
palettes = {
    "呕ywa": [
        "#FF6B6B", "#FF922B", "#FFD93D", "#6BCB77", "#4D96FF", "#845EC2",
        "#FF5E78", "#00C9A7", "#FF4C4C", "#FF7F3F", "#FFCD38", "#28C76F",
        "#2E86DE", "#9D4EDD"
    ],
    "Pastelowa": [
        "#FFB3BA", "#FFDFBA", "#FFFFBA", "#BAFFC9", "#BAE1FF", "#E0BBE4",
        "#FFCCE5", "#C2F0FC", "#FFE5E5", "#FFF1BA", "#E6FFBA", "#BAFFE1",
        "#D4E7FF", "#F3D1FF"
    ],
    "Odcienie niebieskiego": [
        "#001F3F", "#003566", "#00509E", "#0074D9", "#419DFF", "#7ABFFF",
        "#A8D8FF", "#D6ECFF", "#002855", "#004E92", "#1A73E8", "#5DA9FF",
        "#96C7FF", "#CBE2FF"
    ]
}
#  ZAKADKI NA POCZTKU
tab1, tab2 = st.tabs([" Kalendarz g贸wny", " Kalendarz szczeg贸owy"])

with tab1:
    st.subheader(" Widok kalendarza")
    uploaded_file = st.file_uploader(" Wczytaj plik Excel z akcjami", type=["xlsx"])
    st.subheader(" Wybierz palet kolor贸w dla kalendarza")
    selected_palette_tab1 = st.selectbox("Paleta dla kalendarza", list(palettes.keys()), key="palette_tab1")

    if uploaded_file:
        df = pd.read_excel(uploaded_file)
        df["Data startu"] = pd.to_datetime(df["Data startu"])
        df["Data koca"] = pd.to_datetime(df["Data koca"])

        palette = palettes[selected_palette_tab1]
        unique_names = df["Nazwa akcji"].unique()
        color_map = {name: palette[i % len(palette)] for i, name in enumerate(unique_names)}

        events = []
        for _, row in df.iterrows():
            events.append({
                "start": row["Data startu"].strftime("%Y-%m-%d"),
                "end": row["Data koca"].strftime("%Y-%m-%d"),
                "title": row["Nazwa akcji"],
                "color": color_map[row["Nazwa akcji"]],
            })

        calendar_options = {
            "initialView": "dayGridMonth",
            "headerToolbar": {"left": "prev,next today", "center": "title", "right": "dayGridMonth,dayGridWeek,dayGridDay"},
            "height": 750,
            "contentHeight": "auto",
            "aspectRatio": 1.5,
            "navLinks": True,
            "editable": False,
            "dayMaxEventRows": True,
            "locale": "pl",
            "firstDay": 1
        }

        calendar(events=events, options=calendar_options)
    else:
        st.info(" Najpierw wczytaj plik Excel, aby zobaczy kalendarz.")

with tab2:
    st.subheader(" Widok kalendarza szczeg贸owego")
    uploaded_file_tab2 = st.file_uploader(" Wczytaj plik csv (raport wolnego)", type=["xlsx"], key="uploader_tab2") # tu zmienilam z csv
    #file_path = os.path.join("szczegolowe.xlsx")
    
    st.subheader(" Wybierz palet kolor贸w dla kalendarza szczeg贸owego")
    selected_palette_tab2 = st.selectbox("Paleta dla kalendarza szczeg贸owego", list(palettes.keys()), key="palette_tab2")

    if uploaded_file_tab2:
    #if os.path.exists(file_path):
        df2 = pd.read_excel(uploaded_file_tab2) #csv na excel i usunelam sep=;
        #df2 = pd.read_excel(file_path)
        #df2 = df2.iloc[:, [0, 22, 23, 32, 7]]
        df2.columns = ["Nazwa akcji", "Data startu", "Data koca", "Zlecenie", "Producent"]
        df2 = df2.drop_duplicates()
        df2["Data startu"] = pd.to_datetime(df2["Data startu"], errors='coerce')
        df2["Data koca"] = pd.to_datetime(df2["Data koca"], errors='coerce')
        next_year = datetime.now().year + 1
        limit_date = pd.Timestamp(year=next_year, month=12, day=31)
        
        # 1. Podstawowy podzia rodzaj贸w promocji
        df2["Rodzaj promocji"] = ""
        df2.loc[df2["Zlecenie"] == 61114, "Rodzaj promocji"] = "Z/P"
        df2.loc[df2["Nazwa akcji"].astype(str).str.contains("ZGZ", na=False), "Rodzaj promocji"] = "ZGZ"
        df2.loc[df2["Zlecenie"] == 27001, "Rodzaj promocji"] = "centralne"
        df2.loc[df2["Nazwa akcji"].astype(str).str.contains("BKS", na=False), "Rodzaj promocji"] = "sieci"
        #df2.loc[df2["Rodzaj promocji"] == "", "Rodzaj promocji"] = "regionalne"
        df2.loc[df2["Nazwa akcji"].astype(str).str.contains("RPM", na=False), "Rodzaj promocji"] = "RPM"
        df2.loc[df2["Nazwa akcji"].astype(str).str.contains("IPRA", na=False), "Rodzaj promocji"] = "IPRA"
        # Wszystko, co nadal puste, staje si "regionalne pozostae"
        df2.loc[df2["Rodzaj promocji"] == "", "Rodzaj promocji"] = "regionalne pozostae"

        # Zamieniamy daty wiksze ni偶 limit_date na limit_date
        df2.loc[df2["Data koca"] > limit_date, "Data koca"] = limit_date
        df2 = df2.dropna(subset=["Data startu", "Data koca"])

        # Dodanie opcji "Wszystkie" do listy rodzaj贸w promocji
        rodzaje_dostepne = list(df2["Rodzaj promocji"].unique())
        rodzaje_dostepne.sort()
        #rodzaje_dostepne = ["Wszystkie"] + rodzaje_dostepne
        #rodzaje_dostepne = ["Z/P", "ZGZ", "centralne", "sieci", "regionalne"]

        #wybrany_rodzaj = st.selectbox("Wybierz rodzaj promocji", options=rodzaje_dostepne, key="select_rodzaj_promocji")
        # Domylnie wybieramy np. "Wszystkie"
        wybrany_rodzaj = st.selectbox(
            "Wybierz rodzaj promocji",
            options=rodzaje_dostepne,
            index=0 # <- to oznacza, 偶e domylnie zostanie wybrana pierwsza pozycja listy
        )

        # Filtrowanie po rodzaju promocji lub pozostawienie wszystkiego
        #if wybrany_rodzaj == "Wszystkie":
        df_rodzaj_filtered = df2.copy()
        #if wybrany_rodzaj == "regionalne":
            # Dodatkowy podzia dla regionalnych
            #df_regional = df2[df2["Rodzaj promocji"] == "regionalne"].copy()
            #df_regional.loc[df_regional["Nazwa akcji"].astype(str).str.contains("RPM", na=False), "Rodzaj promocji"] = "RPM"
            #df_regional.loc[df_regional["Nazwa akcji"].astype(str).str.contains("IPRA", na=False), "Rodzaj promocji"] = "IPRA"
            #df_regional.loc[~df_regional["Rodzaj promocji"].isin(["RPM", "IPRA"]), "Rodzaj promocji"] = "regionalne pozostae"

            # Wyb贸r podrodzaju regionalnego
            #podrodzaje = df_regional["Rodzaj promocji"].unique()
            #podrodzaje = sorted(podrodzaje)
            #podrodzaje = ["Wszystkie"] + list(podrodzaje)

            #wybrany_podrodzaj = st.selectbox("Wybierz podrodzaj regionalny", options=podrodzaje, key="select_podrodzaj_regionalny")

            #if wybrany_podrodzaj == "Wszystkie":
                #df_rodzaj_filtered = pd.concat([df2[df2["Rodzaj promocji"] != "regionalne"], df_regional])
            #else:
                #df_rodzaj_filtered = pd.concat([
                    #df2[df2["Rodzaj promocji"] != "regionalne"],
                    #df_regional[df_regional["Rodzaj promocji"] == wybrany_podrodzaj]
                #])
        #else:
            #df_rodzaj_filtered = df2[df2["Rodzaj promocji"] == wybrany_rodzaj]

        # Lista producent贸w z ju偶 przefiltrowanego zbioru, z opcj "Wszystkie"
        producenci = list(df_rodzaj_filtered["Producent"].unique())
        producenci.sort()
        #producenci = ["Wszystkie"] + producenci
        wybrany_producent = st.selectbox("Wybierz producenta do wywietlenia", options=producenci, key="select_producent",
            index=0) # <- to oznacza, 偶e domylnie zostanie wybrana pierwsza pozycja listy)

        # Ostateczne filtrowanie po producencie
        if wybrany_producent == "Wszystkie":
            df_final = df_rodzaj_filtered.copy()
        else:
            df_final = df_rodzaj_filtered[df_rodzaj_filtered["Producent"] == wybrany_producent]

        #  Usuwanie duplikat贸w NAZW PROMOCJI (wa偶ne: jeli promocja ma wielu producent贸w, poka偶e si raz)
        df_final = df_final.sort_values("Data startu")
        df_final = df_final.drop_duplicates(subset=["Nazwa akcji"], keep="first")

        # Przygotowanie kolor贸w i event贸w do kalendarza
        palette2 = palettes[selected_palette_tab2]
        unique_names2 = df_final["Nazwa akcji"].unique()
        color_map2 = {name: palette2[i % len(palette2)] for i, name in enumerate(unique_names2)}


        events2 = []
        for _, row in df_final.iterrows():
            events2.append({
                "start": row["Data startu"].strftime("%Y-%m-%d"),
                "end": row["Data koca"].strftime("%Y-%m-%d"),
                "title": row["Nazwa akcji"],
                "color": color_map2[row["Nazwa akcji"]],
            })

        calendar_options2 = {
            "initialView": "dayGridMonth",
            "headerToolbar": {
                "left": "prev,next today",
                "center": "title",
                "right": "dayGridMonth,dayGridWeek,dayGridDay"
            },
            "height": 750,
            "contentHeight": "auto",
            "aspectRatio": 1.5,
            "navLinks": True,
            "editable": False,
            "dayMaxEventRows": True,
            "locale": "pl",
            "firstDay": 1
        }

        calendar(events=events2, options=calendar_options2)

    else:
        st.info(" Najpierw wczytaj plik Excel, aby zobaczy kalendarz szczeg贸owy.")


